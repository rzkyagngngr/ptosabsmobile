name: Build iOS IPA

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main

jobs:
  build-ios:
    runs-on: macos-latest # FREE macOS runner with Xcode
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Expo CLI
        run: npm install -g expo-cli @expo/ngrok

      - name: Prebuild iOS
        run: npx expo prebuild --platform ios --clean

      - name: Check generated workspace
        run: |
          echo "Contents of ios directory:"
          ls -la ios/
          echo "Finding xcworkspace:"
          find ios/ -name "*.xcworkspace" -type d

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: pod install

      - name: Setup Node binary for React Native bundler
        run: |
          echo "NODE_BINARY=$(which node)" >> $GITHUB_ENV
          node --version
          npm --version

      - name: Build iOS (unsigned for Sideloadly)
        working-directory: ios
        env:
          NODE_BINARY: node
        run: |
          WORKSPACE=$(find . -name "*.xcworkspace" -type d | head -n 1 | xargs basename)
          SCHEME=$(echo "$WORKSPACE" | sed 's/.xcworkspace//')
          echo "Building workspace: $WORKSPACE with scheme: $SCHEME"
          
          # Ensure node is in PATH for React Native bundler
          export PATH="$PATH:$(dirname $(which node))"
          echo "Node location: $(which node)"
          echo "Node version: $(node --version)"
          
          # Build for generic iOS device
          set -o pipefail
          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath $PWD/build/"$SCHEME".xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            NODE_BINARY="$(which node)" \
            clean archive 2>&1 | tee build.log
          
          # Check if archive was created
          if [ ! -d "$PWD/build/$SCHEME.xcarchive" ]; then
            echo "ERROR: Archive was not created!"
            echo "Last 50 lines of build log:"
            tail -50 build.log
            exit 1
          fi
          
          echo "✅ Archive created successfully at: $PWD/build/$SCHEME.xcarchive"

      - name: Create IPA from .app bundle
        working-directory: ios
        run: |
          SCHEME=$(find . -name "*.xcworkspace" -type d | head -n 1 | xargs basename | sed 's/.xcworkspace//')
          
          # Verify archive exists
          if [ ! -d "build/$SCHEME.xcarchive" ]; then
            echo "ERROR: Archive not found at build/$SCHEME.xcarchive"
            exit 1
          fi
          
          # Debug: Check archive structure
          echo "=== Archive structure ==="
          ls -R build/"$SCHEME".xcarchive/ | head -100
          
          # Find .app location
          APP_PATH=$(find build/"$SCHEME".xcarchive -name "*.app" -type d | head -n 1)
          echo "Found .app at: $APP_PATH"
          
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found in archive!"
            exit 1
          fi
          
          # Create Payload directory
          mkdir -p build/Payload
          
          # Copy .app to Payload
          cp -r "$APP_PATH" build/Payload/
          
          # Create IPA (zip file)
          cd build
          zip -r "$SCHEME-unsigned.ipa" Payload
          
          echo "IPA created: $SCHEME-unsigned.ipa"
          ls -lh "$SCHEME-unsigned.ipa"
      
      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ios/build.log
          retention-days: 7

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: pelindo-absensi-unsigned.ipa
          path: ios/build/*-unsigned.ipa
          retention-days: 30

      - name: Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: ios/build/*-unsigned.ipa
          tag_name: v1.0.${{ github.run_number }}
          name: iOS Build v1.0.${{ github.run_number }}
          body: |
            iOS IPA build (unsigned)
            
            **How to install:**
            1. Download Sideloadly: https://sideloadly.io
            2. Download the .ipa file below
            3. Connect iPhone via USB
            4. Open Sideloadly, drag .ipa file
            5. Login with your Apple ID (free account)
            6. Sideloadly will sign & install automatically
            
            ⚠️ App will expire in 7 days, re-sign with Sideloadly to refresh.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
