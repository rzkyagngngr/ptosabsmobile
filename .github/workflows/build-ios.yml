name: Build iOS IPA

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main

jobs:
  build-ios:
    runs-on: macos-latest # FREE macOS runner with Xcode
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Expo CLI
        run: npm install -g expo-cli @expo/ngrok

      - name: Prebuild iOS
        run: npx expo prebuild --platform ios --clean

      - name: Check generated workspace
        run: |
          echo "Contents of ios directory:"
          ls -la ios/
          echo "Finding xcworkspace:"
          find ios/ -name "*.xcworkspace" -type d

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: pod install

      - name: Build iOS (unsigned for Sideloadly)
        working-directory: ios
        run: |
          WORKSPACE=$(find . -name "*.xcworkspace" -type d | head -n 1 | xargs basename)
          SCHEME=$(echo "$WORKSPACE" | sed 's/.xcworkspace//')
          echo "Building workspace: $WORKSPACE with scheme: $SCHEME"
          
          # Build for generic iOS device
          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath $PWD/build/"$SCHEME".xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            clean archive | xcpretty || xcodebuild -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath $PWD/build/"$SCHEME".xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            clean archive

      - name: Create IPA from .app bundle
        working-directory: ios
        run: |
          SCHEME=$(find . -name "*.xcworkspace" -type d | head -n 1 | xargs basename | sed 's/.xcworkspace//')
          
          # Create Payload directory
          mkdir -p build/Payload
          
          # Copy .app to Payload
          cp -r build/"$SCHEME".xcarchive/Products/Applications/*.app build/Payload/
          
          # Create IPA (zip file)
          cd build
          zip -r "$SCHEME-unsigned.ipa" Payload
          
          echo "IPA created: $SCHEME-unsigned.ipa"
          ls -lh "$SCHEME-unsigned.ipa"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: pelindo-absensi-unsigned.ipa
          path: ios/build/*-unsigned.ipa
          retention-days: 30

      - name: Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: ios/build/*-unsigned.ipa
          tag_name: v1.0.${{ github.run_number }}
          name: iOS Build v1.0.${{ github.run_number }}
          body: |
            iOS IPA build (unsigned)
            
            **How to install:**
            1. Download Sideloadly: https://sideloadly.io
            2. Download the .ipa file below
            3. Connect iPhone via USB
            4. Open Sideloadly, drag .ipa file
            5. Login with your Apple ID (free account)
            6. Sideloadly will sign & install automatically
            
            ⚠️ App will expire in 7 days, re-sign with Sideloadly to refresh.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
